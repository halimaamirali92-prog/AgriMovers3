<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriMovers Admin Panel</title>
    <!-- Bootstrap CSS for responsive design and components -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Custom CSS for AgriMovers theme -->
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        .main-content {
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
        }
        .navbar {
            background-color: #28a745;
            color: white;
        }
        .navbar-brand {
            color: white !important;
        }
        .welcome-section {
            background-image: url('https://www.shutterstock.com/image-photo/vintage-red-tractor-bronte-provicial-260nw-2603223577.jpg');
            background-size: cover;
            background-position: center;
            padding: 60px;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .menu-buttons .btn {
            margin: 10px;
            width: 300px;
        }
        .content-section {
            display: none;
        }
        .back-btn {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">AgriMovers Admin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Main Content Area -->
            <div class="col-12 main-content">
                <!-- Admin Menu Section -->
                <div id="menu" class="content-section welcome-section">
                    <h2>Welcome to AgriMovers Admin Panel</h2>
                    <p>Manage user accounts, resolve disputes, flag issues, and generate reports for operational insights.</p>
                    <div class="menu-buttons">
                        <button class="btn btn-primary btn-lg" onclick="showSection('users')">Manage Users</button>
                        <button class="btn btn-primary btn-lg" onclick="showSection('disputes')">Dispute Resolution</button>
                        <button class="btn btn-primary btn-lg" onclick="showSection('flags')">Flag Suspicious Behavior</button>
                        <button class="btn btn-primary btn-lg" onclick="showSection('reports')">Generate Reports</button>
                    </div>
                </div>

                <!-- Manage User Accounts Section -->
                <section id="users" class="content-section">
                    <button class="btn btn-secondary back-btn" onclick="showSection('menu')">Back to Admin Menu</button>
                    <div class="card">
                        <div class="card-header">
                            <h5>Manage User Accounts</h5>
                        </div>
                        <div class="card-body">
                            <p>View or delete farmer and transporter profiles.</p>
                            <!-- Dynamic user table -->
                            <table class="table table-striped" id="userTable">
                                <thead>
                                    <tr>
                                        <th>User ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Type</th>
                                        <th>Created At</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows populated dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Dispute Resolution Section -->
                <section id="disputes" class="content-section">
                  <button class="btn btn-secondary back-btn" onclick="showSection('menu')">Back to Admin Menu</button>
                  <div class="card">
                  <div class="card-header">
                     <h5>Dispute Resolution</h5>
                      </div>
                      <div class="card-body">
                      <p>Review and resolve disputes between farmers and transporters.</p>
                    <!-- Dynamic dispute list -->
                 <ul class="list-group" id="disputeList">
                <!-- Items populated dynamically -->
              </ul>
          </div>
        </div>
      </section>

                <!-- Flag Suspicious Behavior Section -->
                <section id="flags" class="content-section">
                    <button class="btn btn-secondary back-btn" onclick="showSection('menu')">Back to Admin Menu</button>
                    <div class="card">
                        <div class="card-header">
                            <h5>Flag Suspicious Behavior</h5>
                        </div>
                        <div class="card-body">
                            <p>Monitor and flag accounts for suspicious activities. Flagging will suspend the user.</p>
                            <form id="flagForm">
                                <div class="mb-3">
                                    <label for="userId" class="form-label">User ID</label>
                                    <input type="text" class="form-control" id="userId" placeholder="Enter User ID" required>
                                </div>
                                <div class="mb-3">
                                    <label for="reason" class="form-label">Reason for Flag</label>
                                    <textarea class="form-control" id="reason" rows="3" required></textarea>
                                </div>
                                <button type="submit" class="btn btn-danger">Flag User</button>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Generate Reports Section -->
                <section id="reports" class="content-section">
                    <button class="btn btn-secondary back-btn" onclick="showSection('menu')">Back to Admin Menu</button>
                    <div class="card">
                        <div class="card-header">
                            <h5>Generate Operational Reports</h5>
                        </div>
                        <div class="card-body">
                            <p>View reports on busiest regions, common issues, and feedback trends.</p>
                            <!-- Placeholder for report options -->
                            <select class="form-select mb-3">
                                <option selected>Select Report Type</option>
                                <option value="regions">Busiest Regions</option>
                                <option value="issues">Common Issues</option>
                                <option value="feedback">Feedback Trends</option>
                            </select>
                            <button class="btn btn-primary">Generate Report</button>
                            <!-- Placeholder for report output -->
                            <div id="reportOutput" class="mt-3">
                                <!-- Dynamic content like charts or tables would go here -->
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS for interactive components -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- Custom JS for navigation and dynamic content -->
    <script>
        // Show admin menu by default
        document.getElementById('menu').style.display = 'block';

        function showSection(id) {
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            // Show the selected section
            document.getElementById(id).style.display = 'block';

            // If showing users, populate the table
            if (id === 'users') {
                populateUserTable();
            } else if (id === 'disputes') {
                populateDisputeList();
            }
        }

        async function populateUserTable() {
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = ''; // Clear existing rows

            try {
                const response = await fetch('/admin/users');
                if (!response.ok) {
                    throw new Error('Failed to fetch users');
                }
                const users = await response.json();

                users.forEach(user => {
                    const isSuspended = user.suspended === 1;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.fullname}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>${new Date(user.created_at).toLocaleString()}</td>
                        <td>${isSuspended ? 'Suspended' : 'Active'}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching users:', error);
                tbody.innerHTML = '<tr><td colspan="7">Error loading users</td></tr>';
            }
        }

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const response = await fetch(`/admin/delete-user/${userId}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        populateUserTable();
                    } else {
                        alert('Failed to delete user');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Error deleting user');
                }
            }
        }

        async function populateDisputeList() {
  const list = document.getElementById('disputeList');
  list.innerHTML = '';  // Clear existing items

  try {
    const response = await fetch('/admin/disputes');
    if (!response.ok) {
      throw new Error('Failed to fetch disputes');
    }
    const disputes = await response.json();

    if (disputes.length === 0) {
      list.innerHTML = '<li class="list-group-item">No disputes found</li>';
      return;
    }

    disputes.forEach(dispute => {
      const item = document.createElement('li');
      item.className = 'list-group-item d-flex justify-content-between align-items-center';
      item.innerHTML = `
        Dispute #${dispute.id}: ${dispute.description} - ${dispute.farmer_name || 'Unknown Farmer'} vs ${dispute.transporter_name || 'Unknown Transporter'} (Status: ${dispute.status})
        <div>
          <button class="btn btn-sm btn-warning me-2" onclick="resolveDispute(${dispute.id})">Resolve</button>
          <button class="btn btn-sm btn-danger" onclick="deleteDispute(${dispute.id})">Delete</button>
        </div>
      `;
      list.appendChild(item);
    });
  } catch (error) {
    console.error('Error fetching disputes:', error);
    list.innerHTML = '<li class="list-group-item text-danger">Error loading disputes</li>';
  }
}

//handles disputes
async function resolveDispute(disputeId) {
  const notes = prompt('Enter resolution notes (optional):');
  try {
    const response = await fetch(`/admin/resolve-dispute/${disputeId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ notes })
    });
    if (response.ok) {
      alert('Dispute resolved');
      populateDisputeList();  // Refresh list
    } else {
      alert('Failed to resolve dispute');
    }
  } catch (error) {
    console.error('Resolve error:', error);
    alert('Error resolving dispute');
  }
}

async function deleteDispute(disputeId) {
  if (confirm('Are you sure you want to delete this dispute?')) {
    try {
      const response = await fetch(`/admin/delete-dispute/${disputeId}`, {
        method: 'DELETE'
      });
      if (response.ok) {
        alert('Dispute deleted');
        populateDisputeList();  // Refresh list
      } else {
        alert('Failed to delete dispute');
      }
    } catch (error) {
      console.error('Delete error:', error);
      alert('Error deleting dispute');
    }
  }
}

        // Handle flag form submission (now acts like suspend)
        document.getElementById('flagForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const userId = document.getElementById('userId').value;
    const reason = document.getElementById('reason').value;

    if (confirm(`Are you sure you want to flag and suspend user ${userId}?`)) {
        try {
            const response = await fetch(`/admin/toggle-suspend/${userId}`, {  // <-- Changed to match server route
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })  // Still sending reason, but server ignores it for now
            });
            if (response.ok) {
                alert('User flagged and suspended successfully');
                document.getElementById('flagForm').reset();
                // Optionally refresh the user table if you're in the 'users' section
                if (document.getElementById('users').style.display === 'block') {
                    populateUserTable();
                }
            } else {
                const errorData = await response.json();
                alert(`Failed to flag and suspend user: ${errorData.message || response.statusText}`);
            }
        } catch (error) {
            console.error('Flag suspend error:', error);
            alert('Error flagging and suspending user');
        }
    }
});


        console.log('Admin panel loaded. Navigation and dynamic scripts added.');
    </script>
</body>
</html>