<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriMovers Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
   <style>
    body { 
        background-color: #f8f9fa; 
        font-family: 'Arial', sans-serif; 
    }
    .main-content { padding: 20px; }
    .card { 
        margin-bottom: 20px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
    }
    .navbar { 
        background: linear-gradient(90deg, #28a745, #20c997) !important; 
    }
    .navbar-brand, .nav-link { 
        color: white !important; 
    }

    /* ← THIS IS THE ONLY PART CHANGED → */
    .welcome-section {
        position: relative;
        background: url('uploads/admin.jpg.jpeg');
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;
         min-height: 80vh;
         border-radius: 20px;
         margin: 20px 0 40px;
         color: white;
         overflow: hidden;
        
    }
    
    /* ← END OF CHANGE → */

    .menu-buttons .btn { 
        margin: 12px; 
        width: 340px; 
        font-size: 18px; 
        padding: 16px; 
    }
    .content-section { display: none; }
    .back-btn { margin-bottom: 20px; }
    .search-filter-bar { margin-bottom: 20px; }
</style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold fs-4" href="#">AgriMovers Admin</a>
            <div class="d-flex">
                <a class="btn btn-outline-light" href="/logout">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid main-content">

        <!-- MENU -->
        <div id="menu" class="content-section welcome-section">
            <h1 class="display-4 fw-bold mb-4">Welcome Admin</h1>
            <p class="lead mb-5">Full control over the AgriMovers platform</p>
            <div class="menu-buttons">
                <button class="btn btn-primary btn-lg" onclick="showSection('users')">Manage Users</button>
                <button class="btn btn-primary btn-lg" onclick="showSection('requests')">All Requests</button>
                <button class="btn btn-primary btn-lg" onclick="showSection('disputes')">Dispute Resolution</button>
                <button class="btn btn-primary btn-lg" onclick="showSection('reports')">Reports & Stats</button>
            </div>
        </div>

        <!-- USERS -->
        <section id="users" class="content-section">
            <button class="btn btn-secondary back-btn" onclick="showSection('menu')">← Back</button>
            <h3>Manage Users</h3>

            <!-- SEARCH & FILTER -->
            <div class="search-filter-bar d-flex gap-3 flex-wrap">
                <input type="text" id="searchInput" class="form-control w-50" placeholder="Search by name, email or ID..." onkeyup="filterUsers()">
                <select id="roleFilter" class="form-select w-25" onchange="filterUsers()">
                    <option value="">All Roles</option>
                    <option value="farmer">Farmer</option>
                    <option value="transporter">Transporter</option>
                    <option value="admin">Admin</option>
                </select>
                <select id="statusFilter" class="form-select w-25" onchange="filterUsers()">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="suspended">Suspended</option>
                </select>
            </div>

            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0" id="userTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Created</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- REQUESTS -->
        <section id="requests" class="content-section">
            <button class="btn btn-secondary back-btn" onclick="showSection('menu')">← Back</button>
            <h3>All Transport Requests</h3>
            <div id="requestsArea"></div>
        </section>

        <!-- DISPUTES -->
        <section id="disputes" class="content-section">
            <button class="btn btn-secondary back-btn" onclick="showSection('menu')">← Back</button>
            <h3>Dispute Resolution</h3>
            <ul class="list-group" id="disputeList"></ul>
        </section>

        <!-- FLAG / SUSPEND -->
        <section id="flags" class="content-section">
            <button class="btn btn-secondary back-btn" onclick="showSection('menu')">← Back</button>
            <h3>Flag & Suspend User</h3>
            <div class="card">
                <div class="card-body">
                    <form id="flagForm">
                        <div class="mb-3">
                            <label>User ID</label>
                            <input type="number" class="form-control" id="userId" required>
                        </div>
                        <div class="mb-3">
                            <label>Reason (optional)</label>
                            <textarea class="form-control" id="reason" rows="4"></textarea>
                        </div>
                        <button type="submit" class="btn btn-danger btn-lg">Suspend User</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- REPORTS -->
    <section id="reports" class="content-section">
        <button class="btn btn-secondary back-btn" onclick="showSection('menu')">Back</button>
        <h3 class="mt-3">Reports And Statistics</h3>
        <div id="reportOutput" class="text-center py-5"></div>
        </section>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let allUsers = []; // Store all users for client-side filtering

        document.getElementById('menu').style.display = 'block';

        function showSection(id) {
            document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';

            if (id === 'users') populateUserTable();
            if (id === 'disputes') populateDisputeList();
            if (id === 'requests') loadAllRequests();
            if (id === 'reports') loadQuickReport();
        }

        // === USERS WITH SEARCH + FILTER + SUSPEND/UNSUSPEND ===
        async function populateUserTable() {
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = '<tr><td colspan="7">Loading...</td></tr>';

            try {
                const res = await fetch('/admin/users');
                allUsers = await res.json(); // Store globally

                renderUserTable(allUsers);
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-danger">Error loading users</td></tr>';
            }
        }

        function renderUserTable(users) {
            const tbody = document.querySelector('#userTable tbody');
            tbody.innerHTML = '';

            users.forEach(user => {
                const isSuspended = user.suspended === 1;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.fullname}</td>
                    <td>${user.email}</td>
                    <td><span class="badge bg-info">${user.role}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td><span class="badge ${isSuspended ? 'bg-danger' : 'bg-success'}">${isSuspended ? 'Suspended' : 'Active'}</span></td>
                    <td>
                        ${isSuspended ? 
                            `<button class="btn btn-sm btn-success" onclick="toggleSuspend(${user.id}, true)">Unsuspend</button>` :
                            `<button class="btn btn-sm btn-warning" onclick="showFlagSection(${user.id})">Suspend</button>`
                        }
                        <button class="btn btn-sm btn-danger ms-1" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Search + Filter
        function filterUsers() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;

            const filtered = allUsers.filter(user => {
                const matchesSearch = user.fullname.toLowerCase().includes(search) ||
                                    user.email.toLowerCase().includes(search) ||
                                    user.id.toString().includes(search);
                const matchesRole = !role || user.role === role;
                const matchesStatus = status === '' || 
                                    (status === 'active' && user.suspended !== 1) ||
                                    (status === 'suspended' && user.suspended === 1);

                return matchesSearch && matchesRole && matchesStatus;
            });

            renderUserTable(filtered);
        }

        async function toggleSuspend(userId) {
            const user = allUsers.find(u => u.id == userId);
                const isSuspended = user.suspended === 1;

                    if (!confirm(`Are you sure you want to ${isSuspended ? 'UNSUSPEND' : 'SUSPEND'} this user?`)) return;

                 let reason = "";
                 if (!isSuspended) {
                  reason = prompt("Reason for suspension (optional):", "") || "";
              }

                const res = await fetch(`/admin/toggle-suspend/${userId}`, {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify({ reason })
             });

  if (res.ok) {
    alert(isSuspended ? "User unsuspended successfully" : "User suspended successfully");
    populateUserTable();  // Refresh the list
  } else {
    const err = await res.text();
    alert("Failed: " + err);
  }
}

        function showFlagSection(userId) {
            showSection('flags');
            document.getElementById('userId').value = userId;
        }

        async function deleteUser(id) {
            if (confirm('Delete user permanently?')) {
                const res = await fetch(`/admin/delete-user/${id}`, { method: 'DELETE' });
                if (res.ok) populateUserTable();
            }
        }

        // === ALL OTHER FUNCTIONS (requests, disputes, reports, flagForm) ===

        async function loadAllRequests() {
            const area = document.getElementById('requestsArea');
            area.innerHTML = 'Loading...';
            const res = await fetch('/admin/requests');
            const reqs = await res.json();
            let html = `<table class="table table-sm table-hover"><thead class="table-dark"><tr><th>ID</th><th>Farmer</th><th>Transporter</th><th>Produce</th><th>Vehicle</th><th>Status</th><th>Payment Status</th><th>Amount</th></tr></thead><tbody>`;
            reqs.forEach(r => {
                const canApprove = r.payment_status !== 'Paid' && r.total_amount;
                html += `<tr><td>${r.id}</td><td>${r.farmer_name}</td><td>${r.transporter_name || '—'}</td><td>${r.produce}</td><td>${r.vehicleType}</td><td>${r.status}</td><td>${r.payment_status}</td><td>${r.total_amount ? 'KES ' + r.total_amount : '—'}</td><td>${canApprove ? `<button class="btn btn-sm btn-success" onclick="approvePayment(${r.id})">Approve</button>` : ''}</td></tr>`;
            });
            area.innerHTML = html + '</tbody></table>';
        }

        async function approvePayment(id) {
            if (confirm('Approve payment?')) {
                const res = await fetch(`/admin/approve/${id}`, { method: 'POST' });
                if (res.ok) { alert('Approved'); loadAllRequests(); }
            }
        }

        async function populateDisputeList() {
            const list = document.getElementById('disputeList');
            list.innerHTML = 'Loading...';
            const res = await fetch('/admin/disputes');
            const disputes = await res.json();
            list.innerHTML = '';
            if (disputes.length === 0) { list.innerHTML = '<li class="list-group-item">No disputes</li>'; return; }
            disputes.forEach(d => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div><strong>#${d.id}</strong> ${d.description}<br><small>${d.farmer_name} vs ${d.transporter_name} • ${d.status}</small></div>
                    <div>
                        <button class="btn btn-sm btn-success me-2" onclick="resolveDispute(${d.id})">Resolve</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteDispute(${d.id})">Delete</button>
                    </div>`;
                list.appendChild(li);
            });
        }

        async function resolveDispute(id) {
            const notes = prompt('Admin notes (optional):');
            const res = await fetch(`/admin/resolve-dispute/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes })
            });
            if (res.ok) { alert('Resolved'); populateDisputeList(); }
        }

        async function deleteDispute(id) {
            if (confirm('Delete dispute?')) {
                const res = await fetch(`/admin/delete-dispute/${id}`, { method: 'DELETE' });
                if (res.ok) populateDisputeList();
            }
        }

       async function loadQuickReport() {
    const out = document.getElementById('reportOutput');
    out.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-success"></div></div>';

    try {
        const res = await fetch('/admin/report');
        if (!res.ok) {
            const text = await res.text();
            console.error("Report error:", res.status, text);
            throw new Error("Failed to load");
        }
        const d = await res.json();

        out.innerHTML = `
        <h4 class="mb-4 text-success fw-bold">Platform Performance Dashboard</h4>

        <!-- REVENUE CARDS -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card bg-success text-white shadow-lg">
                    <div class="card-body text-center">
                        <h5>Your Earnings (Platform Fee ${d.revenue.platform_fee}%)</h5>
                        <h2 class="display-5 fw-bold">KES ${d.revenue.platform_earnings.toLocaleString()}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h5>Total Revenue Processed</h5>
                        <h2 class="display-5 fw-bold">KES ${d.revenue.total.toLocaleString()}</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h5>Paid to Transporters</h5>
                        <h2 class="display-5 fw-bold">KES ${d.revenue.paid_to_transporters.toLocaleString()}</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Top Regions -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-warning text-dark"><strong>Top Regions</strong></div>
                    <div class="card-body">
                        ${d.busiest_regions.length ? 
                          d.busiest_regions.map(r => `
                            <div class="d-flex justify-content-between border-bottom py-2">
                                <span>${r.location}</span>
                                <strong>${r.count} requests</strong>
                            </div>`).join('') 
                          : '<p class="text-muted">No location data</p>'
                        }
                    </div>
                </div>
            </div>

            <!-- Popular Vehicles -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-info text-white"><strong>Most Used Vehicles</strong></div>
                    <div class="card-body">
                        ${d.popular_vehicles.length ? 
                          d.popular_vehicles.map(v => `
                            <div class="d-flex justify-content-between py-2 border-bottom">
                                <span>${v.vehicleType}</span>
                                <strong>${v.count} times</strong>
                            </div>`).join('') 
                          : '<p class="text-muted">No data</p>'
                        }
                    </div>
                </div>
            </div>

            <!-- Customer Satisfaction -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header ${d.feedback.avg_rating >= 4 ? 'bg-success'.text-white : d.feedback.avg_rating >= 3 ? 'bg-warning' : 'bg-danger text-white'}">
                        <strong>Customer Satisfaction</strong>
                    </div>
                    <div class="card-body text-center">
                        <h1 class="display-4 fw-bold">${d.feedback.avg_rating}/5</h1>
                        <p class="lead">${d.feedback.satisfaction_rate} Satisfaction • ${d.feedback.total_reviews} reviews</p>
                        ${d.feedback.low_rating_count > 0 ? 
                          `<p class="text-danger"><strong>${d.feedback.low_rating_count}</strong> low ratings (≤2 stars)</p>` 
                          : '<p class="text-success fs-5">No major complaints!</p>'
                        }
                    </div>
                </div>
            </div>
        </div>
        `;
    } catch (err) {
        console.error(err);
        out.innerHTML = '<p class="text-danger text-center">Failed to load report</p>';
    }
}

        document.getElementById('flagForm').addEventListener('submit', async e => {
            e.preventDefault();
            const userId = document.getElementById('userId').value;
            const reason = document.getElementById('reason').value;
            if (confirm(`Suspend user ${userId}?`)) {
                const res = await fetch(`/admin/toggle-suspend/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });
                if (res.ok) {
                    alert('User suspended');
                    document.getElementById('flagForm').reset();
                    if (document.getElementById('users').style.display === 'block') populateUserTable();
                }
            }
        });

        // Init
        loadQuickReport();
    </script>
</body>
</html>